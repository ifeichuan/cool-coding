---
title: Spring Security æ¶æ„
description: äº†è§£ Spring Security çš„æ ¸å¿ƒæ¶æ„ï¼ŒæŒæ¡å…¶å·¥ä½œåŸç†å’Œå…³é”®ç»„ä»¶ï¼Œå¸®åŠ©åˆå­¦è€…æ„å»ºå®‰å…¨çš„åº”ç”¨ç¨‹åºã€‚
---

## ä»‹ç»

Spring Security æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”é«˜åº¦å¯å®šåˆ¶çš„å®‰å…¨æ¡†æ¶ï¼Œç”¨äºä¿æŠ¤åŸºäº Spring çš„åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†èº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰ã€æˆæƒï¼ˆAuthorizationï¼‰ã€é˜²æ­¢å¸¸è§æ”»å‡»ï¼ˆå¦‚ CSRFã€XSSï¼‰ç­‰åŠŸèƒ½ã€‚ç†è§£ Spring Security çš„æ¶æ„æ˜¯æŒæ¡å…¶å·¥ä½œåŸç†çš„å…³é”®ã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ Spring Security çš„æ ¸å¿ƒæ¶æ„ï¼ŒåŒ…æ‹¬å…¶å…³é”®ç»„ä»¶ã€å·¥ä½œæµç¨‹ä»¥åŠå¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›æ¦‚å¿µã€‚

---

## Spring Security çš„æ ¸å¿ƒæ¶æ„

Spring Security çš„æ¶æ„ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š

1. **SecurityContextHolder**  
2. **Authentication**  
3. **SecurityFilterChain**  
4. **UserDetailsService**  
5. **AuthenticationManager**  
6. **AccessDecisionManager**  

è®©æˆ‘ä»¬é€ä¸€äº†è§£è¿™äº›ç»„ä»¶çš„ä½œç”¨ã€‚

---

### 1. SecurityContextHolder

`SecurityContextHolder` æ˜¯ Spring Security çš„æ ¸å¿ƒï¼Œç”¨äºå­˜å‚¨å½“å‰ç”¨æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å®ƒé€šè¿‡ `ThreadLocal` å®ç°ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚

```java
SecurityContext context = SecurityContextHolder.getContext();
Authentication authentication = context.getAuthentication();
```

:::tip
`SecurityContextHolder` é»˜è®¤ä½¿ç”¨ `ThreadLocal` å­˜å‚¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä½†å¯ä»¥é€šè¿‡é…ç½®æ›´æ”¹ä¸ºå…¶ä»–æ¨¡å¼ï¼Œå¦‚ `MODE_GLOBAL` æˆ– `MODE_INHERITABLETHREADLOCAL`ã€‚
:::

---

### 2. Authentication

`Authentication` æ¥å£è¡¨ç¤ºå½“å‰ç”¨æˆ·çš„èº«ä»½éªŒè¯ä¿¡æ¯ã€‚å®ƒåŒ…å«ä»¥ä¸‹å…³é”®å±æ€§ï¼š

- `principal`ï¼šå½“å‰ç”¨æˆ·çš„èº«ä»½ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·åæˆ– `UserDetails` å¯¹è±¡ï¼‰ã€‚
- `credentials`ï¼šç”¨æˆ·çš„å‡­è¯ï¼ˆé€šå¸¸æ˜¯å¯†ç ï¼‰ã€‚
- `authorities`ï¼šç”¨æˆ·çš„æƒé™é›†åˆï¼ˆå¦‚è§’è‰²ï¼‰ã€‚

```java
Authentication authentication = new UsernamePasswordAuthenticationToken(
    "user", "password", AuthorityUtils.createAuthorityList("ROLE_USER")
);
```

---

### 3. SecurityFilterChain

`SecurityFilterChain` æ˜¯ Spring Security çš„æ ¸å¿ƒè¿‡æ»¤å™¨é“¾ï¼Œè´Ÿè´£å¤„ç† HTTP è¯·æ±‚çš„å®‰å…¨é€»è¾‘ã€‚æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç»è¿‡ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ï¼š

- `UsernamePasswordAuthenticationFilter`ï¼šå¤„ç†è¡¨å•ç™»å½•ã€‚
- `BasicAuthenticationFilter`ï¼šå¤„ç† HTTP Basic è®¤è¯ã€‚
- `CsrfFilter`ï¼šé˜²æ­¢ CSRF æ”»å‡»ã€‚

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/public/**").permitAll()
            .anyRequest().authenticated()
        )
        .formLogin(form -> form
            .loginPage("/login")
            .permitAll()
        );
    return http.build();
}
```

---

### 4. UserDetailsService

`UserDetailsService` æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚å®ƒé€šå¸¸ä»æ•°æ®åº“æˆ–å…¶ä»–å­˜å‚¨ä¸­åŠ è½½ç”¨æˆ·æ•°æ®ï¼Œå¹¶è¿”å›ä¸€ä¸ª `UserDetails` å¯¹è±¡ã€‚

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("User not found");
        }
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(), user.getPassword(), user.getAuthorities()
        );
    }
}
```

---

### 5. AuthenticationManager

`AuthenticationManager` æ˜¯èº«ä»½éªŒè¯çš„æ ¸å¿ƒæ¥å£ï¼Œè´Ÿè´£éªŒè¯ç”¨æˆ·çš„å‡­è¯ã€‚å®ƒé€šå¸¸å§”æ‰˜ç»™ `ProviderManager`ï¼Œåè€…ä¼šè°ƒç”¨å¤šä¸ª `AuthenticationProvider` è¿›è¡ŒéªŒè¯ã€‚

```java
@Bean
public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
    return config.getAuthenticationManager();
}
```

---

### 6. AccessDecisionManager

`AccessDecisionManager` è´Ÿè´£å†³å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šèµ„æºã€‚å®ƒé€šå¸¸ä¸ `@PreAuthorize` æˆ– `@PostAuthorize` æ³¨è§£ä¸€èµ·ä½¿ç”¨ã€‚

```java
@PreAuthorize("hasRole('ADMIN')")
public void deleteUser(Long userId) {
    // åˆ é™¤ç”¨æˆ·é€»è¾‘
}
```

---

## Spring Security çš„å·¥ä½œæµç¨‹

ä»¥ä¸‹æ˜¯ Spring Security å¤„ç†è¯·æ±‚çš„å…¸å‹å·¥ä½œæµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant SecurityFilterChain
    participant AuthenticationManager
    participant UserDetailsService
    participant AccessDecisionManager

    Client->>SecurityFilterChain: å‘é€è¯·æ±‚
    SecurityFilterChain->>AuthenticationManager: éªŒè¯èº«ä»½
    AuthenticationManager->>UserDetailsService: åŠ è½½ç”¨æˆ·ä¿¡æ¯
    UserDetailsService-->>AuthenticationManager: è¿”å› UserDetails
    AuthenticationManager-->>SecurityFilterChain: è¿”å› Authentication
    SecurityFilterChain->>AccessDecisionManager: æ£€æŸ¥æƒé™
    AccessDecisionManager-->>SecurityFilterChain: è¿”å›å†³ç­–ç»“æœ
    SecurityFilterChain-->>Client: è¿”å›å“åº”
```

---

## å®é™…æ¡ˆä¾‹ï¼šä¿æŠ¤ REST API

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„ REST APIï¼Œéœ€è¦ä¿æŠ¤ `/admin` è·¯å¾„ï¼Œåªå…è®¸ç®¡ç†å‘˜è®¿é—®ã€‚

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .httpBasic(Customizer.withDefaults());
        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails admin = User.withUsername("admin")
            .password("{noop}admin123")
            .roles("ADMIN")
            .build();
        return new InMemoryUserDetailsManager(admin);
    }
}
```

---

## æ€»ç»“

Spring Security çš„æ¶æ„ç”±å¤šä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼ŒåŒ…æ‹¬ `SecurityContextHolder`ã€`Authentication`ã€`SecurityFilterChain`ã€`UserDetailsService`ã€`AuthenticationManager` å’Œ `AccessDecisionManager`ã€‚ç†è§£è¿™äº›ç»„ä»¶åŠå…¶äº¤äº’æ–¹å¼æ˜¯æŒæ¡ Spring Security çš„å…³é”®ã€‚

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæ‚¨å·²ç»äº†è§£äº† Spring Security çš„åŸºæœ¬æ¶æ„åŠå…¶åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥å°è¯•å®ç°æ›´å¤æ‚çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚ OAuth2 æˆ– JWT è®¤è¯ã€‚

---

## é™„åŠ èµ„æº

- [Spring Security å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-security/reference/)
- [Spring Security å®æˆ˜æ•™ç¨‹](https://www.baeldung.com/security-spring)
- [Spring Security GitHub ä»“åº“](https://github.com/spring-projects/spring-security)

---

## ç»ƒä¹ 

1. å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ `UserDetailsService`ï¼Œä»æ•°æ®åº“ä¸­åŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚
2. é…ç½® Spring Securityï¼Œä½¿å…¶æ”¯æŒåŸºäº JWT çš„è®¤è¯ã€‚
3. ä½¿ç”¨ `@PreAuthorize` æ³¨è§£ä¿æŠ¤ä¸€ä¸ªæ–¹æ³•ï¼Œåªå…è®¸ç‰¹å®šè§’è‰²çš„ç”¨æˆ·è®¿é—®ã€‚

Happy Coding! ğŸš€
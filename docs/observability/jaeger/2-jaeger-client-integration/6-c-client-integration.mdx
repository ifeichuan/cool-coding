---
title: C#å®¢æˆ·ç«¯é›†æˆ
description: "å­¦ä¹ å¦‚ä½•åœ¨C#åº”ç”¨ç¨‹åºä¸­é›†æˆJaegerå®¢æˆ·ç«¯ï¼Œå®ç°åˆ†å¸ƒå¼è¿½è¸ªåŠŸèƒ½ã€‚æœ¬æ•™ç¨‹é€‚åˆåˆå­¦è€…ï¼ŒåŒ…å«ä»£ç ç¤ºä¾‹å’Œå®é™…åº”ç”¨åœºæ™¯ã€‚"
---

# C#å®¢æˆ·ç«¯é›†æˆ

## ä»‹ç»

Jaegeræ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œç”±Uberå¼€å‘å¹¶è´¡çŒ®ç»™Cloud Native Computing Foundationï¼ˆCNCFï¼‰ã€‚å®ƒå¸®åŠ©å¼€å‘è€…ç›‘æ§å’Œè¯Šæ–­å¾®æœåŠ¡æ¶æ„ä¸­çš„å¤æ‚äº‹åŠ¡ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åœ¨C#åº”ç”¨ç¨‹åºä¸­é›†æˆJaegerå®¢æˆ·ç«¯ï¼Œä»¥ä¾¿æ”¶é›†å’Œå‘é€è¿½è¸ªæ•°æ®åˆ°JaegeræœåŠ¡å™¨ã€‚

:::note
åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼ˆå¦‚Jaegerï¼‰é€šè¿‡è®°å½•è¯·æ±‚åœ¨å¤šä¸ªæœåŠ¡é—´çš„æµè½¬è·¯å¾„ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£ç³»ç»Ÿè¡Œä¸ºå¹¶è¯Šæ–­æ€§èƒ½é—®é¢˜ã€‚
:::

## å‡†å¤‡å·¥ä½œ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
1. å·²å®‰è£….NET Core 3.1æˆ–æ›´é«˜ç‰ˆæœ¬
2. æœ¬åœ°æˆ–è¿œç¨‹è¿è¡ŒJaegeræœåŠ¡å™¨ï¼ˆå¯é€šè¿‡Dockerå¿«é€Ÿå¯åŠ¨ï¼‰
3. ç†Ÿæ‚‰C#åŸºç¡€è¯­æ³•

## å®‰è£…Jaegerå®¢æˆ·ç«¯åº“

é¦–å…ˆï¼Œé€šè¿‡NuGetå®‰è£…Jaegerçš„C#å®¢æˆ·ç«¯åº“ï¼š

```bash
dotnet add package Jaeger
dotnet add package OpenTracing
dotnet add package OpenTracing.Contrib.NetCore
```

## åŸºæœ¬é…ç½®

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ€å°åŒ–çš„Jaegerå®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹ï¼š

```csharp
using Jaeger;
using Jaeger.Reporters;
using Jaeger.Samplers;
using Jaeger.Senders;
using OpenTracing;

public static class JaegerTracer
{
    public static ITracer CreateTracer(string serviceName)
    {
        var senderConfiguration = new Configuration.SenderConfiguration()
            .WithAgentHost("localhost")  // Jaegerä»£ç†åœ°å€
            .WithAgentPort(6831);       // Jaegerä»£ç†UDPç«¯å£

        var reporter = new RemoteReporter.Builder()
            .WithSender(new UdpSender(senderConfiguration.AgentHost, 
                                     senderConfiguration.AgentPort, 
                                     0))
            .Build();

        var tracer = new Tracer.Builder(serviceName)
            .WithSampler(new ConstSampler(true))  // é‡‡æ ·æ‰€æœ‰è¯·æ±‚
            .WithReporter(reporter)
            .Build();

        return tracer;
    }
}
```

## åœ¨ASP.NET Coreä¸­é›†æˆ

å¯¹äºASP.NET Coreåº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œé›†æˆï¼š

1. åœ¨`Startup.cs`ä¸­é…ç½®æœåŠ¡ï¼š

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddOpenTracing();
    
    services.AddSingleton<ITracer>(serviceProvider =>
    {
        var loggerFactory = serviceProvider.GetRequiredService<ILoggerFactory>();
        
        var tracer = JaegerTracer.CreateTracer("my-awesome-service");
        
        GlobalTracer.Register(tracer);
        
        return tracer;
    });
}
```

2. åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨è¿½è¸ªï¼š

```csharp
[ApiController]
[Route("[controller]")]
public class WeatherForecastController : ControllerBase
{
    private readonly ITracer _tracer;

    public WeatherForecastController(ITracer tracer)
    {
        _tracer = tracer;
    }

    [HttpGet]
    public IEnumerable<WeatherForecast> Get()
    {
        using(var scope = _tracer.BuildSpan("get-weather-forecast").StartActive(true))
        {
            // ä¸šåŠ¡é€»è¾‘ä»£ç ...
            return Enumerable.Range(1, 5).Select(index => new WeatherForecast
            {
                Date = DateTime.Now.AddDays(index),
                TemperatureC = Random.Shared.Next(-20, 55),
                Summary = Summaries[Random.Shared.Next(Summaries.Length)]
            })
            .ToArray();
        }
    }
}
```

## è¿½è¸ªè‡ªå®šä¹‰æ“ä½œ

é™¤äº†è‡ªåŠ¨è¿½è¸ªHTTPè¯·æ±‚ï¼Œä½ è¿˜å¯ä»¥æ‰‹åŠ¨åˆ›å»ºè¿½è¸ªspanï¼š

```csharp
public void ProcessOrder(Order order)
{
    using(var scope = _tracer.BuildSpan("process-order").StartActive(true))
    {
        try
        {
            scope.Span.Log(new Dictionary<string, object>
            {
                ["event"] = "order-processing-started",
                ["orderId"] = order.Id,
                ["customer"] = order.CustomerName
            });

            // å¤„ç†è®¢å•çš„ä¸šåŠ¡é€»è¾‘
            ValidateOrder(order);
            ChargeCustomer(order);
            UpdateInventory(order);
            
            scope.Span.SetTag("success", true);
        }
        catch(Exception ex)
        {
            scope.Span.SetTag("error", true);
            scope.Span.Log(new Dictionary<string, object>
            {
                ["event"] = "error",
                ["error.object"] = ex,
                ["stack"] = ex.StackTrace,
                ["message"] = ex.Message
            });
            throw;
        }
    }
}
```

## å®é™…åº”ç”¨åœºæ™¯

å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç”µå­å•†åŠ¡ç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹æœåŠ¡ï¼š
1. ç”¨æˆ·æœåŠ¡
2. äº§å“ç›®å½•æœåŠ¡
3. è®¢å•æœåŠ¡
4. æ”¯ä»˜æœåŠ¡

å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œè¯·æ±‚ä¼šæµç»æ‰€æœ‰è¿™äº›æœåŠ¡ã€‚é€šè¿‡Jaegerè¿½è¸ªï¼Œä½ å¯ä»¥ï¼š

1. æŸ¥çœ‹å®Œæ•´çš„äº‹åŠ¡è·¯å¾„
2. è¯†åˆ«å“ªä¸ªæœåŠ¡å“åº”æœ€æ…¢
3. å‘ç°å¤±è´¥çš„è¯·æ±‚æ˜¯åœ¨å“ªä¸ªç¯èŠ‚å‡ºç°é—®é¢˜

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant OrderService
    participant PaymentService
    participant InventoryService
    
    User->>Frontend: æäº¤è®¢å•
    Frontend->>OrderService: åˆ›å»ºè®¢å•
    OrderService->>PaymentService: å¤„ç†æ”¯ä»˜
    OrderService->>InventoryService: æ›´æ–°åº“å­˜
    InventoryService-->>OrderService: åº“å­˜æ›´æ–°ç»“æœ
    PaymentService-->>OrderService: æ”¯ä»˜ç»“æœ
    OrderService-->>Frontend: è®¢å•ç¡®è®¤
    Frontend-->>User: æ˜¾ç¤ºè®¢å•ç¡®è®¤
```

## é«˜çº§é…ç½®é€‰é¡¹

### é‡‡æ ·ç­–ç•¥

Jaegeræä¾›äº†å¤šç§é‡‡æ ·ç­–ç•¥æ¥æ§åˆ¶è¿½è¸ªæ•°æ®çš„æ”¶é›†é‡ï¼š

```csharp
// æ¦‚ç‡é‡‡æ ·ï¼ˆä¾‹å¦‚é‡‡æ ·50%çš„è¯·æ±‚ï¼‰
var sampler = new ProbabilisticSampler(0.5);

// é€Ÿç‡é™åˆ¶é‡‡æ ·ï¼ˆä¾‹å¦‚æ¯ç§’æœ€å¤š2ä¸ªè¯·æ±‚ï¼‰
var sampler = new RateLimitingSampler(2);
```

### æ—¥å¿—å’Œæ ‡ç­¾

ä½ å¯ä»¥ä¸ºspanæ·»åŠ ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š

```csharp
using(var scope = _tracer.BuildSpan("complex-operation").StartActive(true))
{
    scope.Span.SetTag("customer-tier", "premium");
    scope.Span.SetTag("priority", "high");
    
    scope.Span.Log("Starting phase 1");
    // ç¬¬ä¸€é˜¶æ®µå¤„ç†...
    
    scope.Span.Log("Starting phase 2");
    // ç¬¬äºŒé˜¶æ®µå¤„ç†...
}
```

## æ€»ç»“

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š
1. å¦‚ä½•åœ¨C#åº”ç”¨ç¨‹åºä¸­é›†æˆJaegerå®¢æˆ·ç«¯
2. åŸºæœ¬çš„é…ç½®å’Œåˆå§‹åŒ–è¿‡ç¨‹
3. åœ¨ASP.NET Coreä¸­çš„é›†æˆæ–¹æ³•
4. åˆ›å»ºè‡ªå®šä¹‰spanå’Œæ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
5. Jaegeråœ¨å®é™…å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨åœºæ™¯

:::tip æœ€ä½³å®è·µ
- ä¸ºæ‰€æœ‰å…³é”®ä¸šåŠ¡æ“ä½œæ·»åŠ è¿½è¸ª
- ä½¿ç”¨æœ‰æ„ä¹‰çš„spanåç§°ï¼ˆå¦‚"checkout-process"è€Œé"span1"ï¼‰
- æ·»åŠ è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·IDã€è®¢å•å·ç­‰ï¼‰
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨é€‚å½“çš„é‡‡æ ·ç­–ç•¥ä»¥æ§åˆ¶æ•°æ®é‡
:::

## è¿›ä¸€æ­¥å­¦ä¹ 

1. [Jaegerå®˜æ–¹æ–‡æ¡£](https://www.jaegertracing.io/docs/)
2. [OpenTracing C# APIè§„èŒƒ](https://github.com/opentracing/specification/blob/master/specification.md)
3. [.NETå¾®æœåŠ¡ä¸­çš„åˆ†å¸ƒå¼è¿½è¸ª](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/monitor-app-health)

## ç»ƒä¹ 

1. åˆ›å»ºä¸€ä¸ªç®€å•çš„ASP.NET Core Web APIï¼Œé›†æˆJaegerè¿½è¸ª
2. æ·»åŠ è‡ªå®šä¹‰spanæ¥è¿½è¸ªç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘
3. é…ç½®ä¸åŒçš„é‡‡æ ·ç­–ç•¥å¹¶è§‚å¯Ÿç»“æœå·®å¼‚
4. å°è¯•åœ¨spanä¸­æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾å’Œæ—¥å¿—

ç¥ä½ è¿½è¸ªæ„‰å¿«ï¼ğŸš€
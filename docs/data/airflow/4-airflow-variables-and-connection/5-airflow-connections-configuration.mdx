---
title: Airflow Connections é…ç½®
description: "äº†è§£å¦‚ä½•åœ¨ Apache Airflow ä¸­é…ç½®å’Œç®¡ç† Connectionsï¼Œä»¥å®ç°ä¸å¤–éƒ¨ç³»ç»Ÿçš„æ— ç¼é›†æˆã€‚"
---

## ä»‹ç»

åœ¨ Apache Airflow ä¸­ï¼Œ**Connections** æ˜¯ç”¨äºç®¡ç†ä¸å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“ã€APIã€äº‘æœåŠ¡ç­‰ï¼‰çš„è¿æ¥é…ç½®çš„æ ¸å¿ƒç»„ä»¶ã€‚é€šè¿‡ Connectionsï¼ŒAirflow å¯ä»¥å®‰å…¨åœ°å­˜å‚¨å’Œè®¿é—®å¤–éƒ¨ç³»ç»Ÿçš„å‡­æ®ï¼ˆå¦‚ç”¨æˆ·åã€å¯†ç ã€API å¯†é’¥ç­‰ï¼‰ï¼Œè€Œæ— éœ€å°†è¿™äº›æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åˆ° DAG æˆ–ä»»åŠ¡ä¸­ã€‚

Connections çš„é…ç½®æ˜¯ Airflow å·¥ä½œæµè‡ªåŠ¨åŒ–çš„é‡è¦éƒ¨åˆ†ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦ä¸å¤šç§å¤–éƒ¨æœåŠ¡äº¤äº’çš„åœºæ™¯ä¸­ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½®å’Œç®¡ç† Airflow Connectionsï¼Œå¹¶é€šè¿‡å®é™…æ¡ˆä¾‹å±•ç¤ºå…¶åº”ç”¨ã€‚

---

## ä»€ä¹ˆæ˜¯ Airflow Connectionsï¼Ÿ

Airflow Connections æ˜¯ä¸€ç§å­˜å‚¨å¤–éƒ¨ç³»ç»Ÿè¿æ¥ä¿¡æ¯çš„æœºåˆ¶ã€‚æ¯ä¸ª Connection åŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š

- **Conn Id**ï¼šè¿æ¥çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
- **Conn Type**ï¼šè¿æ¥ç±»å‹ï¼ˆå¦‚ MySQLã€PostgreSQLã€HTTPã€AWS ç­‰ï¼‰ã€‚
- **Host**ï¼šç›®æ ‡ç³»ç»Ÿçš„ä¸»æœºåœ°å€ã€‚
- **Login**ï¼šç”¨æˆ·åæˆ– API å¯†é’¥ã€‚
- **Password**ï¼šå¯†ç æˆ– API å¯†é’¥ã€‚
- **Port**ï¼šç›®æ ‡ç³»ç»Ÿçš„ç«¯å£å·ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ã€‚
- **Extra**ï¼šå…¶ä»–é…ç½®å‚æ•°ï¼ˆJSON æ ¼å¼ï¼‰ã€‚

Connections å¯ä»¥é€šè¿‡ Airflow çš„ Web UIã€CLI æˆ–ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®å’Œç®¡ç†ã€‚

---

## é…ç½® Airflow Connections

### 1. é€šè¿‡ Web UI é…ç½®

Airflow æä¾›äº†ä¸€ä¸ªç›´è§‚çš„ Web UI æ¥ç®¡ç† Connectionsã€‚ä»¥ä¸‹æ˜¯é…ç½®æ­¥éª¤ï¼š

1. ç™»å½• Airflow Web UIã€‚
2. å¯¼èˆªåˆ° **Admin > Connections**ã€‚
3. ç‚¹å‡» **Create** æŒ‰é’®ã€‚
4. å¡«å†™ä»¥ä¸‹å­—æ®µï¼š
   - **Conn Id**ï¼šå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚ `my_db_connection`ï¼‰ã€‚
   - **Conn Type**ï¼šé€‰æ‹©è¿æ¥ç±»å‹ï¼ˆå¦‚ `MySQL`ï¼‰ã€‚
   - **Host**ï¼šç›®æ ‡ç³»ç»Ÿçš„ä¸»æœºåœ°å€ï¼ˆå¦‚ `localhost`ï¼‰ã€‚
   - **Login**ï¼šç”¨æˆ·åï¼ˆå¦‚ `root`ï¼‰ã€‚
   - **Password**ï¼šå¯†ç ï¼ˆå¦‚ `password`ï¼‰ã€‚
   - **Port**ï¼šç«¯å£å·ï¼ˆå¦‚ `3306`ï¼‰ã€‚
   - **Extra**ï¼šå…¶ä»–é…ç½®å‚æ•°ï¼ˆå¦‚ `{"charset": "utf8"}`ï¼‰ã€‚
5. ç‚¹å‡» **Save** ä¿å­˜é…ç½®ã€‚

:::tip
é€šè¿‡ Web UI é…ç½® Connections æ˜¯æœ€ç›´è§‚çš„æ–¹å¼ï¼Œé€‚åˆåˆå­¦è€…å¿«é€Ÿä¸Šæ‰‹ã€‚
:::

### 2. é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®

Airflow è¿˜æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½® Connectionsã€‚ç¯å¢ƒå˜é‡çš„å‘½åè§„åˆ™ä¸ºï¼š

```
AIRFLOW_CONN_{CONN_ID}=<connection_uri>
```

å…¶ä¸­ï¼Œ`{CONN_ID}` æ˜¯è¿æ¥çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œ`<connection_uri>` æ˜¯è¿æ¥ URIï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```
<conn_type>://<login>:<password>@<host>:<port>/<schema>?<extra_params>
```

ä¾‹å¦‚ï¼Œé…ç½®ä¸€ä¸ª MySQL è¿æ¥ï¼š

```bash
export AIRFLOW_CONN_MY_DB_CONNECTION="mysql://root:password@localhost:3306/mydb?charset=utf8"
```

:::caution
ç¡®ä¿ç¯å¢ƒå˜é‡ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ä¸è¢«æ³„éœ²ã€‚
:::

### 3. é€šè¿‡ CLI é…ç½®

Airflow CLI æä¾›äº† `connections` å‘½ä»¤æ¥ç®¡ç† Connectionsã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨å‘½ä»¤ï¼š

- æ·»åŠ  Connectionï¼š
  ```bash
  airflow connections add my_db_connection --conn-type mysql --conn-host localhost --conn-login root --conn-password password --conn-port 3306
  ```

- åˆ é™¤ Connectionï¼š
  ```bash
  airflow connections delete my_db_connection
  ```

- åˆ—å‡ºæ‰€æœ‰ Connectionsï¼š
  ```bash
  airflow connections list
  ```

---

## åœ¨ DAG ä¸­ä½¿ç”¨ Connections

é…ç½®å¥½ Connections åï¼Œå¯ä»¥åœ¨ DAG ä¸­é€šè¿‡ `BaseHook` æˆ– Operator ä½¿ç”¨å®ƒä»¬ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ `PostgresOperator` çš„ç¤ºä¾‹ï¼š

```python
from airflow import DAG
from airflow.providers.postgres.operators.postgres import PostgresOperator
from airflow.utils.dates import days_ago

default_args = {
    'owner': 'airflow',
    'start_date': days_ago(1),
}

with DAG(
    'example_dag',
    default_args=default_args,
    schedule_interval='@daily',
) as dag:

    query_task = PostgresOperator(
        task_id='run_query',
        postgres_conn_id='my_db_connection',  # ä½¿ç”¨é…ç½®çš„ Connection
        sql='SELECT * FROM my_table;',
    )
```

:::note
ç¡®ä¿åœ¨ DAG ä¸­ä½¿ç”¨çš„ `conn_id` ä¸é…ç½®çš„ Connection ä¸€è‡´ã€‚
:::

---

## å®é™…æ¡ˆä¾‹ï¼šè¿æ¥ AWS S3

å‡è®¾æˆ‘ä»¬éœ€è¦ä» AWS S3 è¯»å–æ•°æ®å¹¶å°†å…¶åŠ è½½åˆ°æ•°æ®åº“ä¸­ã€‚ä»¥ä¸‹æ˜¯é…ç½®å’Œä½¿ç”¨ AWS S3 Connection çš„æ­¥éª¤ï¼š

1. åœ¨ Airflow Web UI ä¸­åˆ›å»ºä¸€ä¸ª AWS S3 Connectionï¼š
   - **Conn Id**ï¼š`my_s3_connection`
   - **Conn Type**ï¼š`S3`
   - **Extra**ï¼š`{"aws_access_key_id": "your_access_key", "aws_secret_access_key": "your_secret_key"}`

2. åœ¨ DAG ä¸­ä½¿ç”¨ `S3Hook` è¯»å–æ•°æ®ï¼š

```python
from airflow import DAG
from airflow.providers.amazon.aws.hooks.s3 import S3Hook
from airflow.utils.dates import days_ago

default_args = {
    'owner': 'airflow',
    'start_date': days_ago(1),
}

with DAG(
    's3_example_dag',
    default_args=default_args,
    schedule_interval='@daily',
) as dag:

    def read_from_s3():
        s3_hook = S3Hook(aws_conn_id='my_s3_connection')
        data = s3_hook.read_key(bucket_name='my_bucket', key='my_file.csv')
        print(data)

    read_task = PythonOperator(
        task_id='read_from_s3',
        python_callable=read_from_s3,
    )
```

---

## æ€»ç»“

Airflow Connections æ˜¯ç®¡ç†ä¸å¤–éƒ¨ç³»ç»Ÿè¿æ¥çš„å…³é”®å·¥å…·ã€‚é€šè¿‡ Web UIã€ç¯å¢ƒå˜é‡æˆ– CLI é…ç½® Connectionsï¼Œå¯ä»¥ç¡®ä¿æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨å­˜å‚¨å’Œä¾¿æ·è®¿é—®ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒConnections èƒ½å¤Ÿæ˜¾è‘—ç®€åŒ–å·¥ä½œæµçš„å¼€å‘å’Œç»´æŠ¤ã€‚

---

## é™„åŠ èµ„æºä¸ç»ƒä¹ 

- **å®˜æ–¹æ–‡æ¡£**ï¼š[Airflow Connections](https://airflow.apache.org/docs/apache-airflow/stable/howto/connection.html)
- **ç»ƒä¹ **ï¼šå°è¯•é…ç½®ä¸€ä¸ªè¿æ¥ Google Cloud Storage çš„ Connectionï¼Œå¹¶åœ¨ DAG ä¸­ä½¿ç”¨å®ƒè¯»å–æ–‡ä»¶ã€‚
- **æ‰©å±•é˜…è¯»**ï¼šå­¦ä¹ å¦‚ä½•ä½¿ç”¨ Airflow çš„ Secrets Backend è¿›ä¸€æ­¥ä¼˜åŒ–æ•æ„Ÿä¿¡æ¯çš„ç®¡ç†ã€‚

Happy coding! ğŸš€
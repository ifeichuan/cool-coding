---
title: Elasticsearch åµŒå¥—èšåˆ
description: äº†è§£Elasticsearchä¸­çš„åµŒå¥—èšåˆï¼ŒæŒæ¡å¦‚ä½•å¯¹åµŒå¥—æ–‡æ¡£è¿›è¡Œå¤æ‚çš„èšåˆåˆ†æã€‚
---

# Elasticsearch åµŒå¥—èšåˆ

Elasticsearch æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œæ”¯æŒå¯¹å¤æ‚æ•°æ®ç»“æ„è¿›è¡Œé«˜æ•ˆçš„æœç´¢å’Œåˆ†æã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°åµŒå¥—æ–‡æ¡£ï¼ˆnested documentsï¼‰çš„æƒ…å†µã€‚åµŒå¥—æ–‡æ¡£æ˜¯æŒ‡åœ¨ä¸€ä¸ªæ–‡æ¡£ä¸­åµŒå…¥å¦ä¸€ä¸ªæ–‡æ¡£ï¼Œè¿™äº›åµŒå…¥çš„æ–‡æ¡£å¯ä»¥ç‹¬ç«‹åœ°è¿›è¡ŒæŸ¥è¯¢å’Œèšåˆã€‚ä¸ºäº†å¯¹åµŒå¥—æ–‡æ¡£è¿›è¡Œèšåˆåˆ†æï¼ŒElasticsearch æä¾›äº†**åµŒå¥—èšåˆï¼ˆNested Aggregationï¼‰**åŠŸèƒ½ã€‚

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»åµŒå¥—èšåˆçš„æ¦‚å¿µã€ä½¿ç”¨æ–¹æ³•ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’ŒæŒæ¡è¿™ä¸€åŠŸèƒ½ã€‚

---

## ä»€ä¹ˆæ˜¯åµŒå¥—èšåˆï¼Ÿ

åœ¨ Elasticsearch ä¸­ï¼ŒåµŒå¥—èšåˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„èšåˆç±»å‹ï¼Œç”¨äºå¯¹åµŒå¥—æ–‡æ¡£è¿›è¡Œèšåˆåˆ†æã€‚åµŒå¥—æ–‡æ¡£é€šå¸¸æ˜¯é€šè¿‡ `nested` æ•°æ®ç±»å‹å®šä¹‰çš„ï¼Œå®ƒä»¬å­˜å‚¨åœ¨çˆ¶æ–‡æ¡£ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šæ˜¯ç‹¬ç«‹çš„ã€‚åµŒå¥—èšåˆå…è®¸æˆ‘ä»¬å¯¹è¿™äº›åµŒå¥—æ–‡æ¡£è¿›è¡Œåˆ†ç»„ã€ç»Ÿè®¡ç­‰æ“ä½œï¼Œè€Œä¸ä¼šå½±å“çˆ¶æ–‡æ¡£çš„å…¶ä»–å­—æ®µã€‚

:::note
åµŒå¥—èšåˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å°†åµŒå¥—æ–‡æ¡£è§†ä¸ºç‹¬ç«‹çš„å®ä½“**ï¼Œå¹¶åœ¨èšåˆè¿‡ç¨‹ä¸­å•ç‹¬å¤„ç†å®ƒä»¬ã€‚
:::

---

## åµŒå¥—èšåˆçš„åŸºæœ¬è¯­æ³•

åµŒå¥—èšåˆçš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "aggs": {
    "nested_agg_name": {
      "nested": {
        "path": "nested_field_path"
      },
      "aggs": {
        "sub_agg_name": {
          "agg_type": { ... }
        }
      }
    }
  }
}
```

- `nested_agg_name`ï¼šåµŒå¥—èšåˆçš„åç§°ã€‚
- `path`ï¼šæŒ‡å®šåµŒå¥—å­—æ®µçš„è·¯å¾„ã€‚
- `sub_agg_name`ï¼šå­èšåˆçš„åç§°ã€‚
- `agg_type`ï¼šå­èšåˆçš„ç±»å‹ï¼ˆå¦‚ `terms`ã€`avg` ç­‰ï¼‰ã€‚

---

## ç¤ºä¾‹ï¼šåµŒå¥—èšåˆçš„å®é™…åº”ç”¨

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”µå•†å¹³å°çš„å•†å“ç´¢å¼•ï¼Œæ¯ä¸ªå•†å“åŒ…å«å¤šä¸ªè¯„è®ºï¼ˆåµŒå¥—æ–‡æ¡£ï¼‰ã€‚æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æ¯ä¸ªå•†å“çš„è¯„è®ºæ•°é‡ï¼Œå¹¶è®¡ç®—æ¯ä¸ªå•†å“çš„å¹³å‡è¯„åˆ†ã€‚

### æ•°æ®ç¤ºä¾‹

```json
{
  "product_name": "Laptop",
  "reviews": [
    {
      "user": "Alice",
      "rating": 5
    },
    {
      "user": "Bob",
      "rating": 4
    }
  ]
}
```

### æŸ¥è¯¢ç¤ºä¾‹

ä»¥ä¸‹æŸ¥è¯¢ä½¿ç”¨åµŒå¥—èšåˆç»Ÿè®¡æ¯ä¸ªå•†å“çš„è¯„è®ºæ•°é‡ï¼Œå¹¶è®¡ç®—å¹³å‡è¯„åˆ†ï¼š

```json
{
  "size": 0,
  "aggs": {
    "products": {
      "terms": {
        "field": "product_name.keyword"
      },
      "aggs": {
        "reviews": {
          "nested": {
            "path": "reviews"
          },
          "aggs": {
            "review_count": {
              "value_count": {
                "field": "reviews.rating"
              }
            },
            "avg_rating": {
              "avg": {
                "field": "reviews.rating"
              }
            }
          }
        }
      }
    }
  }
}
```

### æŸ¥è¯¢ç»“æœ

```json
{
  "aggregations": {
    "products": {
      "buckets": [
        {
          "key": "Laptop",
          "doc_count": 1,
          "reviews": {
            "review_count": {
              "value": 2
            },
            "avg_rating": {
              "value": 4.5
            }
          }
        }
      ]
    }
  }
}
```

ä»ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼Œå•†å“ "Laptop" æœ‰ 2 æ¡è¯„è®ºï¼Œå¹³å‡è¯„åˆ†ä¸º 4.5ã€‚

---

## åµŒå¥—èšåˆçš„è¿›é˜¶ç”¨æ³•

### 1. å¤šå±‚åµŒå¥—èšåˆ

å¦‚æœåµŒå¥—æ–‡æ¡£ä¸­è¿˜æœ‰åµŒå¥—æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨å¤šå±‚åµŒå¥—èšåˆã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ¯ä¸ªè¯„è®ºè¿˜åŒ…å«å¤šä¸ªå›å¤ï¼š

```json
{
  "product_name": "Laptop",
  "reviews": [
    {
      "user": "Alice",
      "rating": 5,
      "replies": [
        {
          "user": "Admin",
          "message": "Thank you!"
        }
      ]
    }
  ]
}
```

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ç»Ÿè®¡æ¯ä¸ªè¯„è®ºçš„å›å¤æ•°é‡ï¼š

```json
{
  "aggs": {
    "reviews": {
      "nested": {
        "path": "reviews"
      },
      "aggs": {
        "replies": {
          "nested": {
            "path": "reviews.replies"
          },
          "aggs": {
            "reply_count": {
              "value_count": {
                "field": "reviews.replies.message.keyword"
              }
            }
          }
        }
      }
    }
  }
}
```

### 2. åå‘åµŒå¥—èšåˆ

åå‘åµŒå¥—èšåˆï¼ˆReverse Nested Aggregationï¼‰å…è®¸æˆ‘ä»¬ä»åµŒå¥—æ–‡æ¡£è¿”å›åˆ°çˆ¶æ–‡æ¡£è¿›è¡Œèšåˆã€‚ä¾‹å¦‚ï¼Œç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è¯„è®ºæ•°é‡ï¼š

```json
{
  "aggs": {
    "reviews": {
      "nested": {
        "path": "reviews"
      },
      "aggs": {
        "users": {
          "terms": {
            "field": "reviews.user.keyword"
          },
          "aggs": {
            "back_to_parent": {
              "reverse_nested": {},
              "aggs": {
                "product_count": {
                  "value_count": {
                    "field": "product_name.keyword"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

---

## å®é™…åº”ç”¨åœºæ™¯

1. **ç”µå•†å¹³å°**ï¼šç»Ÿè®¡æ¯ä¸ªå•†å“çš„è¯„è®ºæ•°é‡å’Œå¹³å‡è¯„åˆ†ã€‚
2. **ç¤¾äº¤ç½‘ç»œ**ï¼šåˆ†ææ¯ä¸ªç”¨æˆ·çš„å¸–å­æ•°é‡åŠå…¶ç‚¹èµæ•°ã€‚
3. **æ—¥å¿—åˆ†æ**ï¼šç»Ÿè®¡æ¯ä¸ªæœåŠ¡çš„é”™è¯¯æ—¥å¿—æ•°é‡åŠå…¶åˆ†å¸ƒã€‚

---

## æ€»ç»“

åµŒå¥—èšåˆæ˜¯ Elasticsearch ä¸­å¤„ç†åµŒå¥—æ–‡æ¡£çš„å¼ºå¤§å·¥å…·ã€‚é€šè¿‡åµŒå¥—èšåˆï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å¤æ‚çš„åµŒå¥—æ•°æ®ç»“æ„è¿›è¡Œçµæ´»çš„èšåˆåˆ†æã€‚æœ¬æ–‡ä»‹ç»äº†åµŒå¥—èšåˆçš„åŸºæœ¬è¯­æ³•ã€å®é™…åº”ç”¨åœºæ™¯ä»¥åŠè¿›é˜¶ç”¨æ³•ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚

---

## é™„åŠ èµ„æºä¸ç»ƒä¹ 

1. **ç»ƒä¹ **ï¼šå°è¯•åœ¨è‡ªå·±çš„ Elasticsearch ç´¢å¼•ä¸­å®ç°åµŒå¥—èšåˆï¼Œå¹¶åˆ†æç»“æœã€‚
2. **å®˜æ–¹æ–‡æ¡£**ï¼š[Elasticsearch Nested Aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-nested-aggregation.html)
3. **è¿›ä¸€æ­¥å­¦ä¹ **ï¼šäº†è§£ Elasticsearch çš„å…¶ä»–èšåˆç±»å‹ï¼Œå¦‚ `terms`ã€`date_histogram` ç­‰ã€‚

Happy Coding! ğŸš€